# 创建高性能的索引

### 5.1 索引基础

#### 5.1.1索引的类型

在MySQL中，索引是在存储引擎层而不是服务层实现。

##### B-TREE索引

B-Tree通常意味着所有的值是按顺序存储的，并且每一个叶子页到根的距离相同。

InnoDB根据主键引用被索引的行。

![image-20191230171533399](/Users/jamiehictk/Documents/Github/note-my-days/img/index-struct.png)

B-Tree索引适合以下类型

1. 全值匹配，和索引中的所有列匹配；
2. 匹配最左前缀，使用索引最左的列；
3. 匹配列前缀，匹配索引列的前缀，或者多列中第一列中前缀；
4. 匹配范围值；
5. 匹配某一列和范围匹配另外一列；
6. 只访问索引的查询（覆盖索引）

满足以上按值查询，也可以用于排序的（order by）需求。

B-Tree索引的限制：

1. 如果不是按照索引的最左列开始查找，则无法使用索引；
2. 不能跳过索引中的列；
3. 查询中某列有范围查询，则其右边的列无法使用索引优化。

##### 哈希索引

将哈希码存在索引中，同时在哈希表中保存指向数据行的指针。

哈希索引的限制：

1. 哈希索引只包含哈希值和行指针，不能使用索引中的值避免读取行（无覆盖索引）；
2. 不是按照索引值顺序存储，无法排序；
3. 不支持部分索引列匹配，使用索引列的全部内容计算哈希值；
4. 只支持等值比较查询，范围查询不支持；
5. 速度很快，但如果冲突严重，效率退化；
6. 冲突严重，索引维护代价高

##### 自适应哈希索引

模拟创建自定义哈希索引

在B-Tree基础上创建一个伪哈希索引，使用哈希值而不是键本身进行索引查找。查询需要在where子句中手动指定使用的哈希函数。

##### 全文索引

### 5.2 索引的优点

优点：

1. 减少服务器需要扫描的数据量；
2. 帮助服务器避免排序和临时表；
3. 将随机I/O变成顺序I/O

三星系统：

1. 索引将相关记录放在一起获得一星；
2. 如果索引中的数据顺序和查找重的顺序一致获得两星；
3. 如果索引中包含查询中需要的全部列

### 5.3 高性能的索引策略

#### 5.3.1 独立的列

索引列不能是表达式的一部分，也不能是函数的参数

#### 5.3.2 前缀索引和索引选择性

索引的选择性指，不重复的索引数（基数）和数据表总记录数的比值，越接近1，查询效率越高。

对于BLOB，TEXT或者很大的VARCHAR，必须使用前缀索引。

诀窍在于前缀索引要足够长以保证高选择性，也不能太长，否则浪费空间。前缀的基数应该接近于完整列的基数。

前缀索引无法做order by和group by，也无法做覆盖扫描。

#### 5.3.3 多列索引

索引合并

#### 5.3.4 选择合适的索引顺序

经验法则：选择性最高的列放索引最前列。但是不如避免随机I/O和排序重要。

#### 5.3.5 聚簇索引

聚簇索引不是一种单独的索引类型，而是一种数据存储类型。InnoDB中，聚簇索引是指同一个结构中保存了索引和数据行。

当表有聚簇索引时，它的数据行存放在索引树的叶子页，因为无法把数据行放在两个地方，所以一张表只有一个聚簇索引。

优点：

1. 相关数据保存在一起，例如根据用户ID聚集数据，读取很少数据页就能获取用户的全部邮件；
2. 数据访问更快，无回表；
3. 使用覆盖索引扫描的查询可以直接使用页节点中的主键值。

缺点：

1. 聚簇索引提高了I/O密集型应用的性能，如果数据全部在内存中，没什么优势；
2. 插入速度依赖插入顺序，如果不是按照主键顺序，加载完使用Optimize table重新组织表；
3. 更新聚簇索引代价高，强制移动被更新的行到新的位置；
4. 给予聚簇索引的表在插入新行，或者主键被修改需要移动到新行，可能面临页分裂问题，必须将某行插入满页中，存储引擎会将该页分裂成两个页面，导致更多的磁盘占用；
5. 聚簇索引可能导致全表扫描较慢，尤其是行比较稀疏，由于页分裂导致数据存储不连续；
6. 二级索引可能较大，因为叶子结点包含了引用行的主键列；
7. 二级索引要回表。

二级索引查找行，存储引擎找到二级索引的叶子结点获取引用行的主键值，根据主键值去聚簇索引查找数据行。这个过程也叫做回表。

为什么二级节点存的是引用行的主键值，而不是主键位置？

防止页分裂，合并时需要维护位置指针。

如果InnoDB表中没有数据要聚集，使用代理主键，比如自增主键，保证数据行按数据写入，根据主键做关联操作性能也好。

顺序主键什么时候造成更坏的结果？

高并发工作负载中，按主键顺序写入造成争用。主键的上届会成为热点。因为所有的插入都发生在这里，并发插入倒入间隙锁争用。另一个热点可能是AUTO_INCREMENT锁机制。